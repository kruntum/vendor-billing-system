# ----------------------------------------------------
# Stage 1: The Builder Stage
# à¹ƒà¸Šà¹‰ Bun à¹€à¸›à¹‡à¸™ Base Image
# ----------------------------------------------------
FROM oven/bun:latest AS builder

# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Working Directory
WORKDIR /app

# 1. à¸£à¸±à¸šà¸„à¹ˆà¸² DATABASE_URL à¹€à¸›à¹‡à¸™ Build Argument (à¸„à¸‡à¹„à¸§à¹‰à¹€à¸œà¸·à¹ˆà¸­à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•/à¸à¸£à¸“à¸µà¸à¸´à¹€à¸¨à¸© à¹à¸•à¹ˆà¸ˆà¸°à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰à¹ƒà¸™à¸à¸²à¸£ migrate)
ARG DATABASE_URL 

# Copy package files
COPY server/package.json server/bun.lockb* ./

# ğŸ”¥ CRITICAL 1: Copy Prisma files à¹à¸¥à¸° config
COPY server/prisma ./prisma/
COPY server/prisma.config.ts ./
# à¸¥à¸šà¸à¸²à¸£ COPY server/.env à¸­à¸­à¸à¹„à¸› à¹€à¸à¸£à¸²à¸°à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ Builder/Runner stage
# à¹à¸¥à¸°à¸„à¹ˆà¸² DATABASE_URL à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸œà¹ˆà¸²à¸™ docker-compose.yml à¹ƒà¸™ Runtime

# Install dependencies (à¸£à¸§à¸¡à¸–à¸¶à¸‡ Prisma CLI)
RUN bun install --frozen-lockfile

# Copy source code and config
COPY server/src ./src/
COPY server/tsconfig.json ./

# 2. Generate Prisma Client (à¹ƒà¸Šà¹‰ --bun à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¸à¸±à¸™à¹„à¸”à¹‰à¸”à¸µà¸à¸±à¸š Bun)
# à¸à¸²à¸£ generate client à¹€à¸›à¹‡à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¹à¸šà¸š Offline (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ DB connection)
RUN bunx --bun prisma generate

# ğŸ”¥ CRITICAL 2: Deploy Migrations
# à¸¥à¸šà¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰à¸­à¸­à¸à¹„à¸›! à¸à¸²à¸£ migrate deploy à¸•à¹‰à¸­à¸‡à¸—à¸³à¹ƒà¸™ Run Time à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
# à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸ˆà¸²à¸ DB service (db:5432) à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹ƒà¸™ Build Time
# (à¸¢à¹‰à¸²à¸¢à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰à¹„à¸›à¸—à¸µà¹ˆ docker-compose.yml)

# ----------------------------------------------------
# Stage 2: The Runner Stage (Production)
# ----------------------------------------------------
FROM oven/bun:latest AS runner

# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Working Directory
WORKDIR /app

# Copy dependencies à¹à¸¥à¸° generated files à¸ˆà¸²à¸ Builder
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/prisma/schema.prisma ./prisma/schema.prisma

# ğŸ”¥ CRITICAL 3: Copy prisma.config.ts à¸¡à¸²à¸—à¸µà¹ˆ Runner Stage (à¸¢à¸±à¸‡à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸š Runtime)
COPY server/prisma.config.ts ./
# à¸¥à¸šà¸à¸²à¸£ COPY server/.env à¸­à¸­à¸à¹„à¸› (à¸„à¹ˆà¸² Environment Variables à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸œà¹ˆà¸²à¸™ docker-compose.yml)

# Copy source code and package files
COPY server/src ./src/
# ğŸ”¥ CRITICAL 4: Copy Prisma Generated Client à¸ˆà¸²à¸ Builder (à¹€à¸à¸£à¸²à¸° server/src à¸ˆà¸²à¸ Host à¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¸¡à¸µà¹„à¸Ÿà¸¥à¹Œà¸™à¸µà¹‰)
COPY --from=builder /app/src/generated ./src/generated
COPY server/package.json ./
COPY server/fonts ./fonts/  
# à¸ªà¸£à¹‰à¸²à¸‡ public directory (à¸•à¸²à¸¡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“)
RUN mkdir -p /app/public

# Expose port
EXPOSE 8801

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD bun run -e "fetch('http://localhost:8801/health').then(r => r.ok ? process.exit(0) : process.exit(1))" || exit 1

# Start server
# à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰à¸ˆà¸°à¸–à¸¹à¸ Override à¸”à¹‰à¸§à¸¢ command à¹ƒà¸™ docker-compose.yml (à¸ªà¸³à¸«à¸£à¸±à¸š migrate deploy)
CMD ["bun", "run", "start"]